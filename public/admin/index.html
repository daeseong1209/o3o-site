<!doctype html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta name="robots" content="noindex" />
		<meta name="theme-color" content="#f2f4f6" />
		<title>o3o.team CMS</title>
		<script>
			(function () {
				try {
					var key = 'theme';
					var stored = localStorage.getItem(key);
					var theme =
						stored === 'dark' || stored === 'light'
							? stored
							: window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
								? 'dark'
								: 'light';
					document.documentElement.dataset.theme = theme;
					document.documentElement.style.colorScheme = theme;
					var meta = document.querySelector('meta[name="theme-color"]');
					if (meta) meta.setAttribute('content', theme === 'dark' ? '#0b0f19' : '#f2f4f6');
				} catch (e) {
					// ignore
				}
			})();
		</script>
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Instrument+Sans:opsz,wght@8..14,400..700&family=Space+Grotesk:wght@400..700&display=swap"
			rel="stylesheet"
		/>
		<link rel="stylesheet" href="/admin/admin.css" />
	</head>
	<body>
		<div class="cms-shell">
			<div id="nc-root"></div>
		</div>
		<div class="cms-fab" aria-hidden="false">
			<button class="theme-toggle" type="button" data-theme-toggle aria-label="Toggle theme"></button>
			<a class="cms-fab-link" href="/" rel="nofollow">Site</a>
		</div>
		<script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
		<script src="/admin/preview-templates.js"></script>
		<script>
			if (window.CMS && typeof window.CMS.registerPreviewStyle === 'function') {
				window.CMS.registerPreviewStyle('/admin/preview.css');
			}
		</script>
		<script>
			(function () {
				var key = 'theme';
				var root = document.documentElement;
				var btn = document.querySelector('[data-theme-toggle]');
				if (!btn) return;
				var cmsMark = 'data-o3o-cms-dark';
				var cmsObserver = null;
				var cmsRaf = 0;

				function getStoredTheme() {
					try {
						return localStorage.getItem(key);
					} catch (e) {
						return null;
					}
				}

				function getTheme() {
					return root.dataset.theme === 'dark' ? 'dark' : 'light';
				}

				function parseRgb(color) {
					if (!color || color === 'transparent') return null;
					var m = color.match(/rgba?\(([^)]+)\)/i);
					if (!m) return null;
					var parts = m[1].split(',').map(function (p) {
						return parseFloat(p.trim());
					});
					if (parts.length < 3) return null;
					if (Number.isNaN(parts[0]) || Number.isNaN(parts[1]) || Number.isNaN(parts[2])) return null;
					return {
						r: parts[0],
						g: parts[1],
						b: parts[2],
						a: parts.length > 3 && !Number.isNaN(parts[3]) ? parts[3] : 1,
					};
				}

				function isLightColor(color, minValue, alphaMin) {
					var rgb = parseRgb(color);
					if (!rgb) return false;
					if (rgb.a < alphaMin) return false;
					return rgb.r >= minValue && rgb.g >= minValue && rgb.b >= minValue;
				}

				function getDarkVars() {
					var styles = getComputedStyle(root);
					return {
						panel: styles.getPropertyValue('--panel').trim() || 'rgba(255, 255, 255, 0.06)',
						panel2: styles.getPropertyValue('--panel-2').trim() || 'rgba(255, 255, 255, 0.04)',
						text: styles.getPropertyValue('--text').trim() || 'rgba(255, 255, 255, 0.92)',
						border: styles.getPropertyValue('--border').trim() || 'rgba(255, 255, 255, 0.12)',
					};
				}

				function clearCmsDarkPatches() {
					var cmsRoot = document.getElementById('nc-root');
					if (!cmsRoot) return;
					var patched = cmsRoot.querySelectorAll('[' + cmsMark + ']');
					patched.forEach(function (el) {
						el.style.removeProperty('background-color');
						el.style.removeProperty('color');
						el.style.removeProperty('border-color');
						el.removeAttribute(cmsMark);
					});
					cmsRoot.style.removeProperty('background-color');
					cmsRoot.removeAttribute(cmsMark);
				}

				function patchCmsNode(el, vars) {
					if (!el || !el.tagName) return;
					var tag = el.tagName;
					if (
						tag === 'IMG' ||
						tag === 'SVG' ||
						tag === 'PATH' ||
						tag === 'VIDEO' ||
						tag === 'CANVAS' ||
						tag === 'IFRAME'
					)
						return;

					var computed = getComputedStyle(el);
					var changed = false;

					if (isLightColor(computed.backgroundColor, 232, 0.85)) {
						el.style.setProperty('background-color', vars.panel, 'important');
						changed = true;
					}

					if (isLightColor(computed.color, 220, 0.85)) {
						el.style.setProperty('color', vars.text, 'important');
						changed = true;
					}

					if (isLightColor(computed.borderColor, 210, 0.5)) {
						el.style.setProperty('border-color', vars.border, 'important');
						changed = true;
					}

					if (
						tag === 'INPUT' ||
						tag === 'TEXTAREA' ||
						tag === 'SELECT' ||
						el.getAttribute('role') === 'textbox' ||
						el.isContentEditable
					) {
						el.style.setProperty('background-color', vars.panel2, 'important');
						el.style.setProperty('color', vars.text, 'important');
						el.style.setProperty('border-color', vars.border, 'important');
						changed = true;
					}

					if (changed) {
						el.setAttribute(cmsMark, '1');
					}
				}

				function applyCmsDarkPatches() {
					var cmsRoot = document.getElementById('nc-root');
					if (!cmsRoot) return;
					var vars = getDarkVars();

					var run = function () {
						if (getTheme() !== 'dark') return;
						patchCmsNode(cmsRoot, vars);
						cmsRoot.querySelectorAll('*').forEach(function (el) {
							patchCmsNode(el, vars);
						});
					};

					run();

					if (cmsObserver) {
						cmsObserver.disconnect();
					}
					cmsObserver = new MutationObserver(function () {
						if (getTheme() !== 'dark') return;
						if (cmsRaf) cancelAnimationFrame(cmsRaf);
						cmsRaf = requestAnimationFrame(run);
					});
					cmsObserver.observe(cmsRoot, {
						childList: true,
						subtree: true,
						attributes: true,
						attributeFilter: ['class', 'style'],
					});
				}

				function syncCmsTheme(theme) {
					if (theme === 'dark') {
						applyCmsDarkPatches();
						setTimeout(function () {
							applyCmsDarkPatches();
						}, 250);
						setTimeout(function () {
							applyCmsDarkPatches();
						}, 900);
						return;
					}

					clearCmsDarkPatches();
					if (cmsObserver) cmsObserver.disconnect();
					if (cmsRaf) {
						cancelAnimationFrame(cmsRaf);
						cmsRaf = 0;
					}
				}

				function setMeta(theme) {
					var meta = document.querySelector('meta[name="theme-color"]');
					if (!meta) return;
					meta.setAttribute('content', theme === 'dark' ? '#0b0f19' : '#f2f4f6');
				}

				function update(theme) {
					btn.textContent = theme === 'dark' ? 'Dark' : 'Light';
					btn.setAttribute('aria-pressed', theme === 'dark' ? 'true' : 'false');
					btn.setAttribute('title', 'Toggle theme');
				}

				function apply(theme, persist) {
					root.dataset.theme = theme;
					root.style.colorScheme = theme;
					setMeta(theme);
					if (persist) {
						try {
							localStorage.setItem(key, theme);
						} catch (e) {
							// ignore
						}
					}
					update(theme);
					syncCmsTheme(theme);
					try {
						var iframes = document.querySelectorAll('iframe');
						iframes.forEach(function (frame) {
							if (frame.contentDocument && frame.contentDocument.documentElement) {
								frame.contentDocument.documentElement.dataset.theme = theme;
								frame.contentDocument.documentElement.style.colorScheme = theme;
							}
						});
					} catch (e) {
						// ignore
					}
				}

				update(getTheme());
				btn.addEventListener('click', function () {
					apply(getTheme() === 'dark' ? 'light' : 'dark', true);
				});

				try {
					if (!getStoredTheme() && window.matchMedia) {
						var mq = window.matchMedia('(prefers-color-scheme: dark)');
						var onChange = function (e) {
							apply(e.matches ? 'dark' : 'light', false);
						};
						if (typeof mq.addEventListener === 'function') mq.addEventListener('change', onChange);
						else if (typeof mq.addListener === 'function') mq.addListener(onChange);
					}
				} catch (e) {
					// ignore
				}
			})();
		</script>
	</body>
</html>
